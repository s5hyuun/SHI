<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container mt-4">
    <div class="d-flex gap-2">
      <input type="text" class="form-control" >
      <button class="btn btn-primary">검색</button>
    </div>

    <h2 class="mt-3">세종시 야간 약국 정보</h2>

    <div id="weather" class="my-3" style="display:none;"></div>

    <div id="content"></div>
  </div>

  <script>
    const input = document.querySelector('input');
    const button = document.querySelector('button');
    const content = document.querySelector('#content');
    const weatherBox = document.querySelector('#weather');

    const OPENWEATHER_KEY = '6edee3c2aa182bc44d18ccb204c98a31';

    button.addEventListener('click', onSearch);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') onSearch(); });

    function onSearch() {
      const q = (input.value || '').trim();
      if (!q) return;
      getPharmacyData(q);
      getWeather(q);
    }

    // 야간 약국 데이터
    async function getPharmacyData(search) {
      try {
        const url = `https://ggoreb.pythonanywhere.com/night_pharmacy/data/?search=${encodeURIComponent(search)}`;
        const res = await fetch(url);
        const result = await res.json();
        const data = result.data || [];

        let html = `<table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr><th>약국명</th><th>전화번호</th><th>주소</th></tr>
          </thead><tbody>`;

        for (const d of data) {
          html += `<tr>
            <td>${d.name ?? '-'}</td>
            <td>${d.tel ?? '-'}</td>
            <td>${d.road_address ?? '-'}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
        content.innerHTML = html;

        document.querySelectorAll("#content tr").forEach(tr => {
          tr.addEventListener('click', (e) => alert(e.target.innerText));
        });
      } catch {
        content.innerHTML = `<div class="alert alert-danger">약국 정보를 불러오지 못했습니다.</div>`;
      }
    }

    // 2) 날씨 데이터
    async function getWeather(search) {
      try {
        const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(search)},KR&limit=1&appid=${OPENWEATHER_KEY}`;
        const geoRes = await fetch(geoUrl);
        const geo = await geoRes.json();

        if (!Array.isArray(geo) || geo.length === 0) {
          return renderWeatherError();
        }

        const { lat, lon } = geo[0];
        const wUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=kr&appid=${OPENWEATHER_KEY}`;
        const wRes = await fetch(wUrl);
        const w = await wRes.json();
        if (Number(w.cod) !== 200) return renderWeatherError();

        renderCompactWeather(w);
      } catch {
        renderWeatherError();
      }
    }

    function renderCompactWeather(w) {
      const temp = Math.round(w.main?.temp ?? 0);
      const hum = w.main?.humidity ?? '-';
      const wind = w.wind?.speed ?? '-';
      const icon = w.weather?.[0]?.icon;

      weatherBox.style.display = "block";
      weatherBox.innerHTML = `
        <div class="border rounded p-2">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span><strong>기온</strong> ${temp}°C</span>
            <span> / </span>
            <span><strong>습도</strong> ${hum}%</span>
            <span> / </span>
            <span><strong>풍속</strong> ${wind} m/s</span>
            ${icon ? `<img alt="weather" src="https://openweathermap.org/img/wn/${icon}.png" style="width:40px;height:40px;">` : ''}
          </div>
        </div>`;
    }

    function renderWeatherError() {
      weatherBox.style.display = "block";
      weatherBox.innerHTML = `<div class="alert alert-warning mb-0">해당 지역의 날씨 정보를 불러오지 못했습니다.</div>`;
    }
  </script>
</body>
